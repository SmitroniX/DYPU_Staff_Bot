<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overview | <%= config.Dashboard.Name %></title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a1625;
            color: #908d96;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .stats-container {
            text-align: center;
            background-color: #2f2b3a;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 920px;
            margin: auto;
            position: relative;
            z-index: 1;
            margin-top: 20px;
            margin-bottom: 35px;
        }

        .alert-beta {
            background-color: #87CEEB;
            color: #333;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            width: 80%;
            max-width: 920px;
            text-align: center;
            font-size: 16px;
            margin: 20px auto;
        }

        .recent-messages {
            margin-top: 20px;
            text-align: center;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            background-color: #37303d;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 900px;
            height: 700px;
            overflow-y: auto;
            margin: auto;
        }

        .message-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .message-item {
            padding: 10px 0;
            margin-bottom: 10px;
            position: relative;
        }

        .message-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-user {
            display: flex;
            align-items: center;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .message-username {
            font-size: 16px;
            color: #fff;
            margin-right: 10px;
        }

        .message-content {
            font-size: 16px;
            color: #ccc;
            flex: 1;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            text-decoration: none;
        }

        .message-content:hover {
            color: #6d5ca5;
        }

        .message-timestamp,
        .message-channel {
            font-size: 14px;
            color: #ccc;
            flex-shrink: 0;
            width: 120px;
        }

        .message-delete {
            color: #ff6f61;
            cursor: pointer;
            margin-left: 10px;
            font-size: 20px;
        }

        .no-messages {
            color: #ccc;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .message-content {
                font-size: 14px;
                word-break: break-all;
                white-space: normal;
            }
            .message-info {
                flex-direction: column;
                align-items: flex-start;
            }
            .message-timestamp,
            .message-channel {
                width: auto;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>
    <%- include('partials/navbar', { user: user, currentPage: 'overview' }) %>

    <div class="stats-container">

            <div class="alert-beta">
                <strong>Beta Notice:</strong> This feature is currently in beta and is under early development. It may contain bugs and issues, it's not the final version. Please report any issues and provide feedback in our Discord.
            </div>

        <h1 style="color: #6d5ca5;">Messages Overview</h1>
        <p style="color: #ccc;">This page shows an overview of all messages sent in the server.</p>
        <p style="color: #ccc;">The messages list refreshes automatically every <%= config.OverviewPage.refreshInterval %> seconds.</p>
        <hr style="border-color: #ccc; margin-top: 10px; margin-bottom: 20px;">

        <div class="recent-messages">
            <ul class="message-list" id="messageList">
                <li class="message-item no-messages">Loading messages...</li>
            </ul>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script>
        const refreshInterval = <%= config.OverviewPage.refreshInterval %> * 1000;

        function fetchMessages() {
            $.ajax({
                url: '/overview/messages',
                method: 'GET',
                success: function(data) {
                    const messageList = $('#messageList');
                    messageList.empty();

                    if (data.length === 0) {
                        messageList.append('<li class="message-item no-messages">No messages found.</li>');
                        return;
                    }

                    data.reverse().forEach(message => {
                        const messageItem = `
                            <li class="message-item" data-message-id="${message.msgID}" data-channel-id="${message.channelID}">
                                <div class="message-info">
                                    <div class="message-user"> 
                                        <img src="${message.avatarURL}" alt="${message.username}" class="message-avatar">
                                        <a href="/view/${message.userID}" target="_blank" class="message-username" style="color: #6d5ca5; text-decoration: none;">${message.username}</a>
                                    </div>
                                    <a href="https://discord.com/channels/${message.guildID}/${message.channelID}/${message.msgID}" target="_blank" class="message-content">${message.message}</a>
                                    <div class="message-timestamp">${new Date(message.timestamp).toLocaleTimeString('en-US', { hour12: true, hour: 'numeric', minute: 'numeric', timeZone: '<%= config.Dashboard.Timezone %>' })}</div>
                                    <div class="message-channel">#${message.channelName}</div>
                                    <i class="fas fa-trash message-delete" title="Delete message"></i>
                                </div>
                            </li>
                            <hr style="border-top: 1px solid #46424f; width: 90%; margin: 10px auto;">
                        `;
                        messageList.append(messageItem);
                    });

                    // Attach click event to delete icons
                    $('.message-delete').click(function() {
                        const messageItem = $(this).closest('.message-item');
                        const messageId = messageItem.data('message-id');
                        const channelId = messageItem.data('channel-id');
                        deleteMessage(messageId, channelId);
                    });
                },
                error: function() {
                    $('#messageList').html('<li class="message-item no-messages">Error loading messages.</li>');
                }
            });
        }

        function deleteMessage(messageId, channelId) {
            $.ajax({
                url: '/overview/messages/delete',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ msgID: messageId, channelID: channelId }),
                success: function(response) {
                    if (response.success) {
                        // Remove the message from the list
                        $(`.message-item[data-message-id="${messageId}"]`).remove();
                    } else {
                        alert('Error deleting message.');
                    }
                },
                error: function() {
                    alert('Error deleting message.');
                }
            });
        }

        $(document).ready(function() {
            console.log("Refresh interval: ", refreshInterval);
            fetchMessages();
            setInterval(fetchMessages, refreshInterval);
        });
    </script>
</body>
</html>
